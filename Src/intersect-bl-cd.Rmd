---
title: "Calculate intersection of blocks and community districts"
author: "Satya Golla and Steve Simon"
date: "Created 2022-03-11"
output: html_document
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding,
  output_dir = "../results", output_format = "all") })
---

This program will calculate which census blocks intersect with which community districts. It relies on information stored in

+ bg.RData
+ bl.RData
+ cd.RData
+ red.RData

### General information

For information about various files, refer to the files that stored the relevant data (e.g., store_block_information.Rmd).

It helps to know the FIPS (Federal Information Processing System) codes for Kansas (20) and Missouri (29).

The important counties for this program are

Cass County, MO (29037)
Clay County, MO (29047)
Jackson County, MO (29095)
Johnson County, KS (20091)
Leavenworth County, KS (20103)
Wyandotte County, KS (20209)

### Load relevant files

```{r setup}
library(sf)
library(tidyverse)
library(magrittr)
path_name <- "../data/"
load(paste0(path_name, "bg", ".RData"))
load(paste0(path_name, "bl", ".RData"))
load(paste0(path_name, "cd", ".RData"))
load(paste0(path_name, "red", ".RData"))
```

### Intersect block groups and community districts

Identify the list of all block groups that partially or completely intersect with any community district.

```{r intersect-bg}
bg                                     %>%
  st_intersection(cd)                  %>%
  select(-geometry)                    %>%
  pull(bg_id)                           -> bg_list
glimpse(bg_list)
```

Now get a list of all census blocks that lie inside any of these block groups.

```{r merge-blocks}
bl                                     %>%
  pull(bl_id)                          %>%
  str_sub(1, 12)                       %>%
  bind_cols(bl$bl_id)                  %>%
  set_names(c("bg_id", "bl_id"))        -> bl_list
glimpse(bl_list)
```

### Intersect blocks and community districts


```{r intersect-bl}
bl                                     %>%
  st_intersection(cd)                   -> cd_intersection
glimpse(cd_intersection)
```

```{r calculate-proportions}
cd_intersection                        %>%
  st_area                              %>%
  as.numeric                           %>%
  tibble                               %>%
  set_names("in_area")                 %>%
  bind_cols(cd_intersection)           %>%
  mutate(bg_id=str_sub(bl_id, 1, 12))  %>%
  mutate(prop_in=in_area/bl_area)      %>%
  select(
    bg_id,
    bl_id, 
    cd_id, 
    prop_in)                           %>%
  full_join(bl_list, 
    by=c("bg_id", "bl_id"))            %>%
  replace_na(list(prop_in=0))          %>%
  full_join(red, 
    by=c("bg_id", "bl_id"))            %>%
  mutate(people_in=people*prop_in)     %>%
  mutate(units_in=units*prop_in)        -> bl_counts
glimpse(bl_counts)
```

```{r calculate-bg-weights}
bl_counts                              %>%
  group_by(bg_id, cd_id)               %>%
  summarize(
    people=sum(people),
    people_in=round(sum(people_in)),
    units=sum(units),
    units_in=round(sum(units_in)))     %>%
  ungroup                              %>%
  group_by(bg_id)                      %>%
    mutate(
      people=sum(people),
      people_in=sum(people_in),
      units=sum(units),
      units_in=sum(units_in))           -> bg_counts
glimpse(bg_counts)
```

### Save the information in an RData file.

```{r save}
save(
  bg_counts,
  bg_list,
  bl_counts,
  bl_list,
  cd_intersection,
  file="../Data/weights.RData")
```