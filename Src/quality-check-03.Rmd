---
title: "Quality check 03, Block group intersections with community districts"
author: "Satya Golla and Steve Simon"
date: "Created 2022-03-21"
output: html_document
---

This program examines tracts that only partially intersect with community districts.

### Load relevant files

```{r setup}
library(sf)
library(tidyverse)
library(magrittr)
path_name <- "../data/"
load(paste0(path_name, "bl", ".RData"))
glimpse(bl)
load(paste0(path_name, "cd", ".RData"))
glimpse(cd)
load(paste0(path_name, "icd", ".RData"))
glimpse(icd)
load(paste0(path_name, "red", ".RData"))
glimpse(red)
load(paste0(path_name, "bg", ".RData"))
glimpse(bg)
load(paste0(path_name, "co", ".RData"))
clist <- c(
  "20091",
  "20103",
  "20209",
  "29037",
  "29047",
  "29095",
  "29165")
co                                     %>%
  filter(GEOID %in% clist)              -> co
glimpse(co)

```

### Find community ids

```{r find}
icd                                    %>%
  tibble                               %>%
  distinct(cd_id)                      %>%
  arrange(cd_id)                       %>%
  pull(cd_id)                           -> cd_list
```

```{r functions}
county_plot <- function(co, cd, i) {
  cd %<>% filter(cd_id==i)
  ggplot(co, aes())                     +
    geom_sf(
      fill=NA,
      color="darkgreen")                +
    ggtitle(cd$cd_name)                 +
    geom_sf(
      data=cd,
      aes(),
      fill="white",
      color="darkred")                  -> plot_co
  plot(plot_co)
}

extract_bg <- function(icd, i) {
  icd                                  %>%
    tibble                             %>%
    filter(cd_id==i)                   %>%
    filter(pct_in > 2)                 %>%
    distinct(bg_id)                    %>%
    arrange(bg_id)                     %>%
    pull(bg_id)                       
}

extract_bl <- function(icd, i, j) {
  icd                                  %>%
    tibble                             %>%
    filter(cd_id==i)                   %>%
    filter(bg_id==j)                   %>%
    filter(pct_in > 2)                 %>%
    distinct(bl_id)                    %>%
    arrange(bl_id)                     %>%
    pull(bl_id)                       
}


bg_plot <- function(cd, i, bg, j, icd, bl_list) {
  cd_filter <- cd$cd_id==i
  bg_filter <- bg$bg_id==j
  bl_filter <- icd$bg_id==j & icd$bl_id %in% bl_list
  s1 <- filter(cd, cd_filter)
  s2 <- filter(bg, bg_filter)
  s3 <- filter(icd, bl_filter)
  ggplot(s1, aes())                     +
    geom_sf(
      fill="white",
      color="darkred",
      size=2)                           +
    geom_sf(
      data=s2,
      aes(),
      fill="lightgreen",
      color="darkgreen")                +
    ggtitle(j)                          +
    geom_sf(
      data=s3,
      aes(),
      fill="pink",
      color="darkred")                  -> plot_bg
  plot(plot_bg)
}
```

```{r loop}
for (i in cd_list[1:5]) {
  county_plot(co, cd, i)
  bg_list <- extract_bg(icd, i)
  for (j in bg_list) {
    bl_list <- extract_bl(icd, i, j)
    bg_plot(cd, i, bg, j, icd, bl_list)
  }
}
```


<!---Key census links go here--->
