---
title: "Quality check 03, Block group intersections with community districts"
author: "Satya Golla and Steve Simon"
date: "Created 2022-03-21"
output: html_document
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding,
  output_dir = "../results", output_format = "all") })  
---

This program examines tracts that only partially intersect with community districts.

### Load relevant files

```{r setup}
library(sf)
library(tidyverse)
library(magrittr)
path_name <- "../data/"

load(paste0(path_name, "bg", ".RData"))
glimpse(bg)

load(paste0(path_name, "bl", ".RData"))
glimpse(bl)

load(paste0(path_name, "cd", ".RData"))
glimpse(cd)

load(paste0(path_name, "co", ".RData"))
glimpse(co)

load(paste0(path_name, "red", ".RData"))
glimpse(red)

load(paste0(path_name, "cd-intersections", ".RData"))
glimpse(bg_cd_intersection)
glimpse(bl_cd_intersection)

load(paste0(path_name, "cd-weights", ".RData"))
glimpse(bg_counts)
glimpse(bg_list)
glimpse(bl_counts)
glimpse(bl_list)

clist <- c(
  "20091",
  "20103",
  "20209",
  "29037",
  "29047",
  "29095",
  "29165")
co                                     %>%
  filter(GEOID %in% clist)              -> co
glimpse(co)
```

### Find community ids

```{r find}
cd                                     %>%
  tibble                               %>%
  distinct(cd_id)                      %>%
  arrange(cd_id)                       %>%
  pull(cd_id)                           -> cd_list
```

```{r functions}
county_plot <- function(co, cd, i) {
  cd %<>% filter(cd_id==i)
  ggplot(co, aes())                     +
    geom_sf(
      fill=NA,
      color="darkred")                  +
    ggtitle(cd$cd_name)                 +
    geom_sf(
      data=cd,
      aes(),
      fill="white",
      color="darkgreen")                -> plot_co
  plot(plot_co)
}

extract_bg <- function(bl_counts, i) {
  bl_counts                            %>%
    tibble                             %>%
    filter(cd_id==i)                   %>%
    distinct(bg_id)                    %>%
    arrange(bg_id)                     %>%
    pull(bg_id)                       
}

extract_bl <- function(bl_list, j) {
  bl_list                              %>%
    tibble                             %>%
    filter(bg_id==j)                   %>%
    distinct(bl_id)                    %>%
    arrange(bl_id)                     %>%
    pull(bl_id)                       
}

bg_plot <- function(cd, i, bg, j) {
  ti <- j
  cd_i <- filter(cd, cd_id==i)
  bg_j <- filter(bg, bg_id==j)
  ggplot(cd_i, aes())                   +
    geom_sf(
      fill="lightgreen",
      color="darkgreen")                +
    geom_sf(
      data=bg_j,
      aes(),
      fill=NA,
      color="darkred")                  +
    ggtitle(ti)                         -> plot_bg
  plot(plot_bg)
}

display_blocks <- function(bl_counts, j) {
  bl_counts                            %>%
    filter(bg_id==j)                   %>%
    select(
      bl_id,
      prop_in,
      people_in,
      units_in)                        %>%
    data.frame                         %>%
    print
}
```

  ti <- paste0(
    s3$bg_id, ", ",
    s3$people_in, "/", 
    s3$people, ", ",
    s3$housing_units_in, "/", 
    s3$housing_units)


```{r loop}
for (i in cd_list[7]) {
  county_plot(co, cd, i)
  bg_list <- extract_bg(bl_counts, i)
  for (j in bg_list) {
    display_blocks(bl_counts, j)
    bg_plot(cd, i, bg, j)
  }
}
```


<!---Key census links go here--->
