---
title: "Quality check 03, Block group intersections with community districts"
author: "Satya Golla and Steve Simon"
date: "Created 2022-03-21"
output: html_document
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding,
  output_dir = "../results", output_format = "all") })  
---

This program examines tracts that only partially intersect with community districts.

### Load relevant files

```{r setup}
library(sf)
library(tidyverse)
library(magrittr)
path_name <- "../data/"
load(paste0(path_name, "bl", ".RData"))
glimpse(bl)
load(paste0(path_name, "cd", ".RData"))
glimpse(cd)
load(paste0(path_name, "weights", ".RData"))
glimpse(weights)
load(paste0(path_name, "red", ".RData"))
glimpse(red)
load(paste0(path_name, "bg", ".RData"))
glimpse(bg)
load(paste0(path_name, "co", ".RData"))
clist <- c(
  "20091",
  "20103",
  "20209",
  "29037",
  "29047",
  "29095",
  "29165")
co                                     %>%
  filter(GEOID %in% clist)              -> co
glimpse(co)
```

### Find community ids

```{r find}
cd                                     %>%
  tibble                               %>%
  distinct(cd_id)                      %>%
  arrange(cd_id)                       %>%
  pull(cd_id)                           -> cd_list
```

```{r functions}
county_plot <- function(co, cd, i) {
  cd %<>% filter(cd_id==i)
  ggplot(co, aes())                     +
    geom_sf(
      fill=NA,
      color="darkred")                  +
    ggtitle(cd$cd_name)                 +
    geom_sf(
      data=cd,
      aes(),
      fill="white",
      color="darkgreen")                -> plot_co
  plot(plot_co)
}

extract_bg <- function(b3, i) {
  b3                                   %>%
    tibble                             %>%
    filter(cd_id==i)                   %>%
    distinct(bg_id)                    %>%
    arrange(bg_id)                     %>%
    pull(bg_id)                       
}

extract_bl <- function(b1, i, j) {
  b1                                   %>%
    tibble                             %>%
    filter(cd_id==i)                   %>%
    filter(bg_id==j)                   %>%
    distinct(bl_id)                    %>%
    arrange(bl_id)                     %>%
    pull(bl_id)                       
}


bg_plot <- function(cd, i, bg, j, b3) {
  s1 <- filter(cd, cd_id==i)
  s2 <- filter(bg, bg_id==j)
  s3 <- filter(b3, cd_id==i & bg_id==j)
  ti <- paste0(
    s3$bg_id, ", ",
    s3$people_in, "/", 
    s3$people, ", ",
    s3$housing_units_in, "/", 
    s3$housing_units)
  ggplot(s1, aes())                     +
    geom_sf(
      fill="white",
      color="darkgreen")                +
    geom_sf(
      data=s2,
      aes(),
      fill=NA,
      color="darkred")                  +
    ggtitle(ti)                         -> plot_bg
  plot(plot_bg)
}

display_blocks <- function(b2, i, j) {
  b2                                   %>%
    filter(cd_id==i)                   %>%
    filter(bg_id==j)                   %>%
    mutate(prop_in=round(prop_in, 2))  %>%
    mutate(
      people_in=round(people_in))      %>%
    mutate(
      housing_units_in=
        round(housing_units_in))       %>%
    select(
      bl_id,
      prop_in,
      people_in,
      people,
      housing_units_in,
      housing_units)                   %>%
    data.frame                         %>%
    print
}
```

```{r loop}
for (i in cd_list[7]) {
  county_plot(co, cd, i)
  bg_list <- extract_bg(b3, i)
  for (j in bg_list) {
    display_blocks(b2, i, j)
    bg_plot(cd, i, bg, j, b3)
  }
}
```


<!---Key census links go here--->
